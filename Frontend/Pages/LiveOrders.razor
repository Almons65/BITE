@page "/liveorders"
@using Microsoft.AspNetCore.SignalR.Client
@using BITE.Client
@using System.Diagnostics.CodeAnalysis
@using System.Runtime.CompilerServices
@inject NavigationManager Navigation
@inject HttpClient Http
@inject IJSRuntime JS

<PageTitle>Live Orders</PageTitle>

<h1>BITE Live Orders</h1>

<div class="mb-3">
    <button class="btn btn-danger" @onclick="ClearDatabase">
        <i class="bi bi-trash"></i> Clear All Orders
    </button>
    <button class="btn btn-secondary" @onclick="RefreshOrders">
        Refresh Data
    </button>
</div>

@if (orders.Count == 0)
{
    <p><em>No active orders... hungry yet?</em></p>
}
else
{
    <table class="table table-striped" >
        <thead>
            <tr>
                <th>Customer</th>
                <th>Food</th>
                <th>Status</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var order in orders)
            {
                <tr>
                    <td>@order.CustomerName</td>
                    <td>@order.FoodItem</td>
                    <td>
                        <span class="badge @(order.Status?.Equals("Delivered", StringComparison.OrdinalIgnoreCase) == true ? "bg-secondary" : "bg-success")">@order.Status</span>
                    </td>
                    <td>
                        <div class="btn-group">
                        @if (!string.Equals(order.Status, "Delivered", StringComparison.OrdinalIgnoreCase)) {
                            <button class="btn btn-sm btn-primary" @onclick="() => MarkDelivered(order.Id)">Mark Delivered</button>
                        }
                        <button class="btn btn-sm btn-outline-danger ms-2" @onclick="() => DeleteOrder(order.Id)">
                            <i class="bi bi-x"></i> Delete
                        </button>
                        </div>
                    </td>
                </tr>
            }
        </tbody>
    </table>
}

@code {
    private HubConnection? hubConnection;
    // We changed this from a List<string> to a List<Order> to show real data
    private List<Order> orders = new();

        // 1. LOAD HISTORY: Fetch existing orders from the Database
        protected override async Task OnInitializedAsync()
    {
        // 1. Fetch History
        try {
            orders = await Http.GetFromJsonAsync<List<Order>>("orders") ?? new();
        } catch (Exception ex) 
        {
            Console.WriteLine($"Error loading history: {ex.Message}");
        }

        // 2. Setup Real-time
        hubConnection = new HubConnectionBuilder()
            .WithUrl("http://localhost:5012/orderhub") // Ensure this is /orderhub
            .Build();

        hubConnection.On<Order>("ReceiveNewOrder", (newOrder) =>
        {
            orders.Add(newOrder);
            InvokeAsync(StateHasChanged);
        });

        hubConnection.On<Guid, string>("UpdateOrderStatus", (orderId, newStatus) =>
      {
        Console.WriteLine($"SignalR received update for {orderId}: {newStatus}");
        var orderToUpdate = orders.FirstOrDefault(o => o.Id == orderId);
        if (orderToUpdate != null) {
            orderToUpdate.Status = newStatus;
            InvokeAsync(StateHasChanged);
        }
      });

      hubConnection.On<Guid>("ReceiveOrderDeleted", (deletedId) =>
        {
            var orderToRemove = orders.FirstOrDefault(o => o.Id == deletedId);
            if (orderToRemove != null)
            {
                orders.Remove(orderToRemove);
                InvokeAsync(StateHasChanged);
            }
        });

        await hubConnection.StartAsync();
    }

    private async Task MarkDelivered(Guid id)
    {
        Console.WriteLine($"Sending update for ID: {id}");
        var response = await Http.PutAsync($"orders/{id}/status?status=Delivered", null);
        
        if (response.IsSuccessStatusCode) 
        {
            Console.WriteLine("API update success!");
            await RefreshOrders();
        }
        else 
        {
            Console.WriteLine($"API update failed: {response.StatusCode}");
        }
    }

    private async Task DeleteOrder(Guid id)
    {
        bool confirmed = await JS.InvokeAsync<bool>("confirm", "Are you sure you want to delete this order?");
        if (!confirmed) return;
        var response = await Http.DeleteAsync($"orders/{id}");
        if (!response.IsSuccessStatusCode)
        {
            Console.WriteLine($"Error deleting order: {response.StatusCode}");
        }
    }

    private async Task ClearDatabase()
    {
        bool confirmed = await JS.InvokeAsync<bool>("confirm", "This will wipe ALL history. Are you sure?");
        if (!confirmed) return;

        await Http.DeleteAsync("orders/clear");
        orders.Clear();
        StateHasChanged();
    }

    private async Task RefreshOrders()
    {
        try
        {
            orders = await Http.GetFromJsonAsync<List<Order>>("orders") ?? new();
            StateHasChanged();
            Console.WriteLine("Manual refresh complete. Current order count: " + orders.Count);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Refresh failed: {ex.Message}");
        }
    }
}