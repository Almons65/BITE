@page "/liveorders"
@using Microsoft.AspNetCore.SignalR.Client
@using BITE.Client
@inject NavigationManager Navigation
@inject HttpClient Http  // <--- Inject the HTTP Client

<PageTitle>Live Orders</PageTitle>

<h1>BITE Live Orders</h1>

@if (orders.Count == 0)
{
    <p><em>No active orders... hungry yet?</em></p>
}
else
{
    <table class="table">
        <thead>
            <tr>
                <th>Customer</th>
                <th>Food</th>
                <th>Status</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var order in orders)
            {
                <tr>
                    <td>@order.CustomerName</td>
                    <td>@order.FoodItem</td>
                    <td>
                        <span class="badge bg-success">@order.Status</span>
                    </td>
                </tr>
            }
        </tbody>
    </table>
}

@code {
    private HubConnection? hubConnection;
    // We changed this from a List<string> to a List<Order> to show real data
    private List<Order> orders = new();

        // 1. LOAD HISTORY: Fetch existing orders from the Database
        protected override async Task OnInitializedAsync()
    {
        // 1. Fetch History
        try {
            orders = await Http.GetFromJsonAsync<List<Order>>("orders") ?? new();
        } catch { /* Handle error */ }

        // 2. Setup Real-time
        hubConnection = new HubConnectionBuilder()
            .WithUrl("http://localhost:5012/orderhub") // Ensure this is /orderhub
            .Build();

        hubConnection.On<Order>("ReceiveNewOrder", (newOrder) =>
        {
            orders.Add(newOrder);
            InvokeAsync(StateHasChanged);
        });

        await hubConnection.StartAsync();
    }
}